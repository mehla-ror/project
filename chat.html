<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat</title>
<style>
body{margin:0;font-family:-apple-system;background:#f0f2f5}
.blur{filter:blur(18px)}
#app{height:100vh;display:flex;flex-direction:column}
header{background:#0084ff;color:#fff;padding:14px;text-align:center}
#messages{flex:1;overflow:auto;padding:10px}
.msg{max-width:70%;margin:6px 0;padding:10px;border-radius:18px}
.me{background:#0084ff;color:#fff;margin-left:auto}
.other{background:#fff;border:1px solid #ddd}
#input{display:flex;padding:8px;background:#fff}
#input input{flex:1;border:none;font-size:16px}
</style>
</head>

<body>
<div id="app">
<header>Chat</header>
<div id="messages"></div>
<div id="input">
<input id="text" placeholder="Message">
<button onclick="send()">âž¤</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
if(sessionStorage.getItem("auth")!=="user") location.href="index.html";

firebase.initializeApp({
  apiKey:"AIzaSyClDpYNMrZMCBFlAYjFHdWAJRvTlpmRjds",
  databaseURL:"https://secret-app-c988f-default-rtdb.firebaseio.com"
});

const db = firebase.database();
const user = sessionStorage.getItem("user");
const ref = db.ref("messages");

/* LISTENER (FIXED) */
ref.limitToLast(50).on("child_added", s=>{
  const m = s.val();
  show(m);
});

function send(){
  if(!text.value) return;
  ref.push({
    user,
    text:text.value,
    time:Date.now()
  });
  text.value="";
}

function show(m){
  const d=document.createElement("div");
  d.className="msg "+(m.user===user?"me":"other");
  d.innerText=m.text;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

/* BLUR ON BACKGROUND */
document.addEventListener("visibilitychange",()=>{
  document.body.classList.toggle("blur",document.hidden);
});
</script>
</body>
</html>
