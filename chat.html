<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secret Chat Room</title>
<style>
body { font-family:Arial; padding:10px; }
#chatBox{border:1px solid #ccc;height:400px;overflow:auto;padding:10px;margin-bottom:10px;}
.message{padding:5px;margin:2px;background:#f0f0f0;}
.pinnedMessage{padding:5px;margin:2px;background:#fffa90;}
#weatherOverlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;z-index:100;}
#weatherOverlay iframe{width:100%; height:80%; border:none;}
</style>
</head>
<body>

<h2>Secret Chat Room</h2>
<div id="chatBox"></div>

<input type="text" id="msgInput" placeholder="Type message">
<button onclick="sendMessage(document.getElementById('msgInput').value)">Send</button>
<input type="file" id="fileInput">
<button onclick="sendFile()">Send File</button>

<video id="localVideo" autoplay muted style="width:120px;"></video>
<video id="remoteVideo" autoplay style="width:120px;"></video>
<button onclick="startCall()">Start Call</button>

<div id="weatherOverlay"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyClDpYNMrZMCBFlAYjFHdWAJRvTlpmRjds",
  authDomain: "secret-app-c988f.firebaseapp.com",
  databaseURL: "https://secret-app-c988f-default-rtdb.firebaseio.com",
  projectId: "secret-app-c988f",
  storageBucket: "secret-app-c988f.firebasestorage.app",
  messagingSenderId: "218769667228",
  appId: "1:218769667228:web:8d5fe10b3c25b80e1aa959"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const messagesRef = db.ref('chatMessages');

// ===== IndexedDB =====
let dbLocal;
const request = indexedDB.open("SecretChatDB",1);
request.onupgradeneeded = e => { dbLocal = e.target.result; dbLocal.createObjectStore("messages",{keyPath:"id",autoIncrement:true}); };
request.onsuccess = e => { dbLocal = e.target.result; displayAllMessages(); };

// ===== Current User =====
const currentUser = localStorage.getItem("chatUserName")||"Unknown";

// ===== Shake-to-weather =====
window.addEventListener('devicemotion', e=>{
    let acc = e.accelerationIncludingGravity;
    if(Math.abs(acc.x)+Math.abs(acc.y)+Math.abs(acc.z) > 25){ showWeather(); }
});
function showWeather(){
    const overlay = document.getElementById('weatherOverlay');
    overlay.innerHTML = `
        <h2>Weather</h2>
        <iframe src="https://www.accuweather.com/en/in/karnal/123456/weather-forecast/123456"></iframe>
        <button onclick="document.getElementById('weatherOverlay').style.display='none'">Close</button>
    `;
    overlay.style.display='block';
}

// ===== Send Message =====
function sendMessage(content,file=null,isPinned=false){
    if(!content && !file) return;
    const timestamp = Date.now();
    let msg = {content: content||"", file:null, timestamp, sender: currentUser, isPinned};

    if(file){
        const reader = new FileReader();
        reader.onload = e=>{
            msg.file = {name:file.name,type:file.type,data:e.target.result};
            saveMessageLocal(msg);
            messagesRef.push({content: msg.content, file: {name:file.name,type:file.type}, timestamp:msg.timestamp, sender:msg.sender, isPinned:msg.isPinned});
        };
        reader.readAsDataURL(file);
    } else {
        saveMessageLocal(msg);
        messagesRef.push({content: msg.content, file:null, timestamp:msg.timestamp, sender:msg.sender, isPinned:msg.isPinned});
    }
    document.getElementById('msgInput').value='';
}

// ===== Save to IndexedDB and display =====
function saveMessageLocal(msg){
    const tx = dbLocal.transaction("messages","readwrite");
    tx.objectStore("messages").add(msg);
    displayMessage(msg);
}

// ===== Display Message =====
function displayMessage(msg){
    const chatBox=document.getElementById("chatBox");
    const div=document.createElement("div");
    div.className = msg.isPinned ? "pinnedMessage":"message";
    let html=`<strong>${msg.sender}:</strong> ${msg.content}`;
    if(msg.file && msg.file.data){
        if(msg.file.type.startsWith("image/")) html+=`<br><img src="${msg.file.data}" style="max-width:150px;">`;
        else html+=`<br><a href="${msg.file.data}" target="_blank">ðŸ“Ž ${msg.file.name}</a>`;
    }
    div.innerHTML=html;
    chatBox.appendChild(div);
    chatBox.scrollTop=chatBox.scrollHeight;
}

// ===== Display all stored messages =====
function displayAllMessages(){
    const tx=dbLocal.transaction("messages","readonly");
    const store=tx.objectStore("messages");
    store.openCursor().onsuccess=e=>{
        const cursor=e.target.result;
        if(cursor){ displayMessage(cursor.value); cursor.continue(); }
    };
}

// ===== Send File Button =====
function sendFile(){ const file=document.getElementById('fileInput').files[0]; if(file) sendMessage(null,file); }

// ===== Auto-delete non-pinned messages 24h =====
setInterval(()=>{
    const tx=dbLocal.transaction("messages","readwrite");
    const store=tx.objectStore("messages");
    const now=Date.now();
    store.openCursor().onsuccess=e=>{
        const cursor=e.target.result;
        if(cursor){ if(!cursor.value.isPinned && (now-cursor.value.timestamp>24*60*60*1000)) store.delete(cursor.value.id); cursor.continue(); }
    };
},60*60*1000);

// ===== Firebase Listener =====
messagesRef.on('child_added', snapshot=>{
    const msg = snapshot.val();
    const tx=dbLocal.transaction("messages","readonly");
    const store=dbLocal.transaction("messages","readonly").objectStore("messages");
    let duplicate=false;
    store.openCursor().onsuccess=e=>{
        const cursor=e.target.result;
        if(cursor){
            if(cursor.value.timestamp===msg.timestamp && cursor.value.sender===msg.sender) duplicate=true;
            cursor.continue();
        } else {
            if(!duplicate){
                if(msg.file) msg.file.data=null;
                saveMessageLocal(msg);
            }
        }
    };
});

// ===== WebRTC Voice/Video =====
let localStream,pc;
function startCall(){
    pc=new RTCPeerConnection();
    pc.ontrack=e=>{ document.getElementById('remoteVideo').srcObject=e.streams[0]; };
    navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{
        localStream=stream;
        document.getElementById('localVideo').srcObject=stream;
        stream.getTracks().forEach(track=>pc.addTrack(track,stream));
    });
    // Signaling can be added via Firebase or manual exchange
}
</script>
</body>
</html>